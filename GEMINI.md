# 项目概览

本项目是一个用于编辑和管理 SillyTavern 的 `preset.json` 文件的在线工具。

## 目标
开发一个纯前端的在线编辑工具，用于可视化地编辑和管理 `preset.json` 这个复杂的 Prompt 预设文件。核心是降低维护难度，特别是处理 `prompts` 和 `prompt_order` 部分。

## 技术栈与开发要求
- **框架:** Vue.js
- **构建工具:** Vite
- **UI 相关框架:** Tailwind CSS（v4）+ Headless UI + Heroicons + Splitpanes + vuedraggable + vtooltip
- **状态管理:** Pinia
- **依赖管理:** 使用 npm 进行本地安装（node 和 npm 已全局安装）。所有工具链和依赖项必须安装在当前项目目录，而非全局。
- **开发服务器:** 禁止 Agent 直接运行 `npm run dev` 等会长期占用终端的命令。所有网页测试由用户本人完成。

## 核心设计：状态驱动的 UI

本项目采用 **单一数据源** 架构。所有应用数据——包括 `prompts` 库、`promptOrder`、宏分析结果以及 UI 状态——都集中由 **Pinia** 状态管理（`presetStore`）统一管理。

用户操作通过 **Actions** 分发到 store，进而修改 **State**。Vue 组件通过 **Getters** 和 **计算属性** 响应式订阅这些状态，视图会自动更新。这样的单向数据流让应用更可预测、易维护、便于调试。


---

# 项目需求清单

为了完成该 Prompt 编辑器项目，我们需要明确以下需求。

## 用户使用流程

1. 用户打开网页，在文本框中粘贴或者输入 `preset.json` 的内容。

2. 编辑器解析 `preset.json` 的内容，并将其转换为可视化的结构。

3. 用户通过拖拽的方式调整 Prompt 的顺序，或者添加、删除、隐藏、启用/禁用某些 Prompt。

4. 用户编辑后，提供一个按钮来生成新的 `preset.json` 文件内容，显示生成的 JSON 结构，并允许用户复制。

## 用户界面设计

整体页面由三部分组成，使用 Splitpanes 进行布局：

- **左侧边栏：** Prompt 库（Prompt Library），用户可以在这里查看所有的提示模块，并进行添加、删除、多选与批量删除。可以不显示内容，但必须展示重要的元数据（例如 ID 和名称）。支持搜索过滤。支持点击导航到编辑区。
- **中间编辑区：** 可视化编辑区（Editor），按照 `prompt_order` 对所有的 prompts 进行排序、macro 渲染和展示。可以禁用 prompt，也可以从 `prompt_order` 中删除，但仍保留在 `prompts` 中。支持拖拽排序，点击 Prompt 卡片可高亮显示并导航。
- **右侧边栏：** 使用 Tab 设计，共有两个选项卡。Details 选项卡用于展示当前选中 Prompt 或 Macro 宏的详细信息，支持实时编辑。Variables 选项卡，用于集中管理所有已定义的变量，并提供变量重命名工具。

页面顶端有一个工具栏，用于重置、导入和导出 JSON 文件。导入和导出 JSON 文件的页面是 Modal 弹窗。

整体 UI 现代化，布局可调节，交互组件优雅，滚动条美化。

## Macro 系统

宏（Macro）是 Prompt 编辑的核心功能。所有被宏渲染的文字必须展示为不同的颜色。
在工具栏中应当提供一个按钮，来切换宏（渲染后）和非宏（宏定义本身）的显示模式。
应用能自动扫描所有 Prompt，解析出 `{{...}}` 宏，并建立变量定义 (`setvar`) 与引用 (`getvar`) 的完整关系图。

### 变量相关宏

编辑器需要重点支持渲染以下宏：

- **变量设置 (`setvar`)**：允许用户定义或修改变量。
- **变量获取 (`getvar`)**：允许用户在提示中引用已定义的变量。

对于变量相关的宏，我希望支持一种类似 IDE 中 find reference 的功能。当用户点击某个 setvar/getvar 宏时，编辑器应当高亮显示所有使用了该变量的地方，并在右侧边栏展示该变量的详细信息。

当出现未定义但被引用的变量时，编辑器应当高亮显示这些引用，并在右侧边栏提示用户该变量未定义。

### 其他宏

- **随机选择、摇骰子宏**：无需渲染，只需显示原文，但仍需使用不同颜色标识。
- **注释宏（`{{//...}}`）**：在编辑器中显示为灰色文本，但不影响其他宏的渲染。

---

# `preset.json` 文件结构分析

`preset.json` 文件是一个 SillyTavern 项目使用的、高度模块化和可组合的 Prompt 工程文件。项目内置了一个相对复杂的实例文件（`preset.example.json`）用于开发者参考。

## 核心概念
该 JSON 文件是一个高度模块化和可组合的 Prompt 工程系统。

1.  **`prompts` (提示模块库):** 一个包含大量可复用“提示模块”的数组。每个模块都是一个对象，拥有独立的功能（如设定风格、定义规则、控制格式等）。
2.  **`prompt_order` (提示组装顺序):** 定义了如何从 `prompts` 库中挑选模块，并按照特定顺序将它们组合起来，形成最终发送给 AI 的完整指令。
3.  其他元数据，如 `top_k` 等，控制 AI 的行为和输出。

## 宏（Macro）系统分析 `{{...}}`

文件内广泛使用 `{{...}}` 语法进行模板化，这是整个系统的核心动态能力。已知的宏可分为以下几类：

### 1. 变量设置 (`setvar`)
- **语法:** `{{setvar::变量名::值}}`
- **功能:** 定义或修改一个变量的值，是整个系统的“控制面板”。
- **示例:** `{{setvar::min::1200token}}`, `{{setvar::language::中文}}`

### 2. 变量获取 (`getvar`)
- **语法:** `{{getvar::变量名}}`
- **功能:** 在提示的不同位置引用已定义的变量值。
- **示例:** `{{getvar::min}}`, `{{getvar::language}}`

### 3. 内置变量/占位符
- **功能:** 系统预定义的、用于指代核心上下文信息的基础变量。
- **示例:** `{{user}}`, `{{char}}`, `{{scenario}}`, `{{lastChatMessage}}`

### 4. 随机选择 (`random`)
- **语法:** `{{random::选项1::选项2::...}}`
- **功能:** 从提供的列表中随机选择一个值，用于增加多样性。
- **示例:** `{{random::调情::告知感受::诱惑}}`

### 5. 掷骰 (`roll`)
- **语法:** `{{roll <表达式>}}`
- **功能:** 生成随机数，主要用于生成无意义的噪声以绕过审查。
- **示例:** `{{roll 1d1919819}}`

### 6. 注释 (`//`)
- **语法:** `{{//注释内容}}`
- **功能:** 在提示中添加人类可读的注释，AI 会忽略。
- **示例:** `{{//注解:正文最小字数}}`
